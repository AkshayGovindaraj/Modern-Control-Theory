% The formulation of MPC is stored in this function
% This file will be called for every control move. 
% It gives the Us for the next few times
function [f,g] = mpcform(u,x,ys)

p = 10;
M = 10;

 AB = [0.977761390791996,0.00150731043977111,0.000117641667469991,-0.000176422685625943,0.00129501905548826;
       -0.0456820058180613,1.00557475312109,0.0112938229265131,0.00841260181514146,-0.00592279211589980;
       0.239135558663006,-0.122005380238823,0.877340272569456,-0.0875887698244175,-0.170396289513480;
       -0.0619203332816622,-0.0554430260535420,-0.694358818693494,0.458588285274319,-0.509318375811164;
       -0.0992939667859705,0.0747001069524178,0.228079231663078,0.197952920700409,-0.506199768037661];

B =[5.52327568369997e-05,-0.000283816899255185;
    0.00549612262032187,-0.000221157076027192;
    -0.219358648611253,-0.0122772811617940;
    -1.09329939486152,-0.0699701353719596;
    -0.825582460356569,-0.0530680141005799];

x1 = zeros(5,p+1);

x1(:,1) = x;
uu = ones(p+1,1);
%uu(1) = 10;

for i = 1:(p)
   % keyboard
    x1(:,i+1) = AB*(x1(:,i)) + B*(u(:,i));
end

f = 0;

for i = 1:(p)
 %   for ii=1:3:4
    f = f + uu(i)*transpose(x1(:,i+1) - ys)*(x1(:,i+1) - ys) ;
 %   end
end

for i = 1:(M+1)
%     dy = dy + 0.001*transpose(u(:,i))*(u(:,i)) ;
end

% The rest of the file is used to find the gradient

g = zeros(2,p);
temp = zeros(1,2);

for i = 1:(p)
    for j = i:(p)
        temp = temp + 2*transpose(x1(:,j+1))*(AB^(j-1))*B ;
        %keyboard
    %g(:,i) = transpose(uu(i)*(x1(:,i) - ys)*(AB^()*B)
    end
    g(:,i) = transpose(temp) ; 
    temp = zeros(1,2);
end

end